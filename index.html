<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8">

    <title>Importateur emploi du temps UPEC</title>

    <meta name="description" content="Simplifiez vous la vie étudiante à l'UPEC en important automatiquement chaque semaine votre emploi du temps dans votre agenda Google.">

    <meta property="og:title" content="Importateur emploi du temps UPEC">
    <meta property="og:type" content="non_profit">
    <meta property="og:url" content="https://marvinroger.github.io/upec-timetable-importer">
    <meta property="og:image" content="https://marvinroger.github.io/upec-timetable-importer/img/logo.png">
    <meta property="og:site_name" content="Importateur emploi du temps UPEC">
    <meta property="og:description" content="Simplifiez vous la vie étudiante à l'UPEC en important automatiquement chaque semaine votre emploi du temps dans votre agenda Google.">

    <link rel="icon" type="image/png" href="img/favicon/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="img/favicon/favicon-16x16.png" sizes="16x16">


    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
    <link href="3rd/bootstrap-application-wizard/bootstrap-wizard.css" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script src="3rd/bootstrap-application-wizard/bootstrap-wizard.min.js"></script>
    <script src="3rd/base64/base64.utf8.min.js"></script>
    <script src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script>

    <script>
      // Credentials

      var authed = false;
      var clientId = '75947514866-0cefecs55pomac4t58r5nqp6cdb5bod8.apps.googleusercontent.com';
      var apiKey = 'AIzaSyDeznMWVdVrJE2TyqW5z4aOKI57zgU5GQk';
      var scopes = 'https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/drive.scripts';

      // Init

      function handleClientLoad() {
        gapi.client.setApiKey(apiKey);
      }

      var version;

      $.get('script/latest-version', function(res) {
        version = res.replace('\n', '');
        $('#label_latest_version').text('v' + version);
      });

      $(function() {
        var options = {
          contentWidth: 800,
          contentHeight: 400,
          buttons: {
            cancelText: 'Annuler',
            nextText: 'Suivant',
            backText: 'Précédent',
            submitText: 'Terminer',
            submittingText: 'Terminé'
          },
          keyboard: false,
          backdrop: 'static'
        };
        var wizard = $("#wizard").wizard(options);

        // Wizard - launch

        $("#button_wizard").on('click', function(e) {
          e.preventDefault();
          wizard.show();
        });

        // Wizard - intro

        $("#link_faq").on('click', function(e) {
          e.preventDefault();
          wizard.close();
          var url = location.href;
          location.href = '#faq';
          history.replaceState(null, null, url); 
        });

        // Wizard - ids

        $(document).on('click', '.wizard-next', function(e) {
          if (wizard.getActiveCard().name === 'ids') {
            $('#input_project_id').val('');
            $('#input_resource_id').val('');
            $('.wizard-next').attr('disabled', 'disabled');
          }
        });

        var idsOk = { resource: false, project: false };
        function idsTriggerCheck() {
          if (idsOk.resource && idsOk.project) {
            $('.wizard-next').removeAttr('disabled');
          } else {
            $('.wizard-next').attr('disabled', 'disabled');
          }
        }

        $(document).on('keyup onpaste oninput', '#input_project_id', function(e) {
          idsOk.project = true;

          idsTriggerCheck();
        });

        $(document).on('keyup onpaste oninput', '#input_resource_id', function(e) {
          idsOk.resource = true;

          idsTriggerCheck();
        });

        // Wizard - auth

        var projectId;
        var resourceId;

        $(document).on('click', '.wizard-next', function(e) {
          if (wizard.getActiveCard().name === 'auth') {
            projectId = $('#input_project_id').val();
            resourceId = $('#input_resource_id').val();
            $('.wizard-next').attr('disabled', 'disabled');
          }
        });

        $("#button_auth").on('click', function(e) {
          e.preventDefault();
          $('#button_auth').attr('disabled', 'disabled');
          if (authed) {
            return;
          }

          gapi.auth.init(function onInit() {
            gapi.auth.authorize({client_id: clientId, scope: scopes, immediate: false}, function handleAuthResult(authResult) {
              if (authResult && !authResult.error) {
                authed = true;
                $('#button_auth').text('Accès accordé');
                $('#button_auth').removeClass('btn-primary');
                $('#button_auth').addClass('btn-success');
                $('.wizard-next').removeAttr('disabled');
              } else {
                console.log('Auth failed');
              }
            });
          });
        });

        // Wizard - prepare

        var importerId;

        $(document).on('click', '.wizard-next', function(e) {
          if (wizard.getActiveCard().name === 'prepare') {
            $('#part_agenda_id').hide();
            $('#button_delete').hide();
            $('.wizard-next').attr('disabled', 'disabled');
            gapi.client.load('drive', 'v2', function() {
              var request = gapi.client.drive.files.list({
              'q': "mimeType='application/vnd.google-apps.script' and 'me' in owners"
              });
              request.then(function(res) {
                res.result.items.forEach(function(item) {
                  if (item.title === 'Importateur emploi du temps UPEC') {
                    importerId = item.id;
                  }
                });

                if (importerId) {
                  $('#loading_prepare').text('Vous avez déjà un importateur installé. Vous devez le supprimer pour continuer.');
                  $('#button_delete').show();
                } else {
                  $('#loading_prepare').text("Tout est prêt pour l'installation.");
                  $('.wizard-next').removeAttr('disabled');
                }
              });
            });
          }
        });

        $(document).on('click', '#button_delete', function(e) {
          e.preventDefault();
          $('#button_delete').attr('disabled', 'disabled');
          var request = gapi.client.drive.files.delete({
            'fileId': importerId
          });

          request.then(function() {
            $('#button_delete').hide();
            $('#loading_prepare').hide();
            $('#part_agenda_id').show();
            $('.wizard-next').removeAttr('disabled');
          });
        });

        // Wizard - install1

        var agendaId;

        $(document).on('click', '.wizard-next', function(e) {
          if (wizard.getActiveCard().name === 'install1') {
            agendaId = $('#input_agenda_id').val() || null;
            $('.wizard-next').attr('disabled', 'disabled');
            $('#loading_install1').hide();
          }
        });

        var docId;

        $(document).on('click', '#button_install', function(e) {
          e.preventDefault();
          $('#button_install').attr('disabled', 'disabled');
          $.get('script/importer.json', function(script) {
            $('#loading_install1').show();
            
            var data = {
              "projectId": parseInt(projectId),
              "resourcesId": parseInt(resourceId),
              "calendarId": agendaId,
              "colorPatterns": false
            };

            var base64data = Base64.encode(JSON.stringify(data));
            script = script.replace('${DATA}', base64data);

            var boundary = '-------314159265358979323846';
            var delimiter = "\r\n--" + boundary + "\r\n";
            var close_delim = "\r\n--" + boundary + "--";

            var metadata = {
              'title': 'Importateur emploi du temps UPEC',
              'description': 'Importateur emploi du temps UPEC v' + version,
              'mimeType': 'application/vnd.google-apps.script'
            };

            var base64script = Base64.encode(script);

            var multipartScript = delimiter +
              'Content-Type: application/json\r\n\r\n' +
              JSON.stringify(metadata) +
              delimiter +
              'Content-Type: ' + 'application/vnd.google-apps.script+json' + '\r\n' +
              'Content-Transfer-Encoding: base64\r\n' +
              '\r\n' +
              base64script +
              close_delim;


            var request = gapi.client.request({
              'path': '/upload/drive/v2/files/',
              'method': 'POST',
              'params': {
                uploadType: 'multipart',
                convert: true
              },
              'headers': {
                'Content-Type': 'multipart/mixed; boundary="' + boundary + '"'
              },
              'body': multipartScript
            });

            request.then(function(res) {
              docId = res.result.id;
              $('#button_install').hide();
              $('#loading_install1').text('Prénstallé avec succès.');
              $('.wizard-next').removeAttr('disabled');
            });

          }, 'text');
        });
        
        // Wizard - install2

        $(document).on('click', '.wizard-next', function(e) {
          if (wizard.getActiveCard().name === 'install2') {
            $('#button_doc_drive').attr('href', 'https://script.google.com/d/' + docId + '/edit?usp=drive_web');
          }
        });

        // Wizard - end

        $(document).on('click', '.wizard-next', function(e) {
          if (wizard.getActiveCard().name === 'end') {
            $(document).on('click', '.wizard-next', function(e) {
              wizard.close();
            });
          }
        });
      });
    </script>
  </head>

  <body style="padding-top: 50px; padding-bottom: 20px;">
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" href="#">Importateur emploi du temps UPEC</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
        </div>
      </div>
    </nav>

    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div class="jumbotron">
      <div class="container">
        <div class="row">
          <div class="col-md-8">
            <img src="img/logo.png" alt="Logo" style="width: 128px; float: left; margin-bottom: 10px; margin-right: 20px;">
            <h1>L'emploi du temps UPEC, simplifié</h1>
            <p>
              Ce n'est pas toujours pratique d'aller consulter son emploi du temps sur l'ADE de l'UPEC. J'ai donc créé un outil qui permet, à partir
              d'un compte Google, d'importer automatiquement son emploi du temps dans un agenda Google. Ça ne prend que quelques étapes et un tout petit peu de technique, rien de bien compliqué.
            </p>
            <p>Dernière version : <span class="label label-info" id="label_latest_version">Chargement...</span></p>
            <p><a class="btn btn-primary btn-lg" id="button_wizard" href="#" role="button">Installer une 1<sup>re</sup> fois/Réinstaller après un semestre terminé</a></p>
          </div>
          <div class="col-md-4">
            <img src="img/screenshot.gif" style="height: 400px;" class="img-responsive" alt="Capture d'écran">
          </div>
        </div>
      </div>
    </div>

    <div class="container" id="faq">
      <!-- Example row of columns -->
      <h2>F.A.Q.</h2>
      <h3>Comment ça marche ?</h3>
      <p>
        Google permet à n'importe qui de faire tourner des automatismes sur leurs serveurs par l'intermédiaire de Google Drive. Ces automatismes permettent d'interagir avec leurs services. En l'occurence, cette application fonctionne en installant un automatisme qui importe votre emploi du temps UPEC de façon hebdomadaire. L'automatisme vous apparaît, sur Google Drive, comme un simple fichier dont vous n'avez pas à vous soucier une fois installé.
      </p>
      <h3>Une fois installé, y a plus rien à faire ?</h3>
      <p>
        L'automatisme doit être réinstallé à chaque fois que vous changez de ressource dans ADE. Pour certains, elle change tous les semestres, pour d'autres tous les ans. Pour faire simple : si, sur ADE, votre emploi du temps change de groupe (par exemple de L1 - second semestre à L2 - premier semestre), vous devez réinstaller l'automatisme, sans quoi l'importation réussira, mais n'importera rien.
      </p>
      <h3>Combien ça coûte ?</h3>
      <p>
        Étant donné qu'il n'y a aucun coût de fonctionnement de mon côté, c'est totalement gratuit. Ce qui signifie qu'il s'agit d'un service bénévole et que je ne m'engage à rien. Je l'utilise au quotidien et tout fonctionne correctement, mais si quelque chose venait à dysfonctionner, je ne suis en aucun cas responsable. L'automatisme n'effectue en tout cas aucune action destructive : votre compte Google ne risque rien.
      </p>
      <h3>Ça ne marche pas. Que faire ?</h3>
      <p>
        Essayez de réinstaller l'automatisme, en suivant les instructions à la lettre, et en lisant bien attentivement chaque mail envoyé par l'automatisme. Si ça ne marche toujours pas, vous pouvez me contacter via la page Facebook ou par mail. Je ferais de mon mieux pour y répondre, sans aucune garantie toutefois.
      </p>
      <p><a class="btn btn-default" href="https://www.facebook.com/importateuremploidutempsupec" role="button">Aller vers la page Facebook &raquo;</a></p>
      <p><a class="btn btn-default" href="mailto:importateuremploidutempsupec@marvinroger.fr" role="button">Envoyer un mail à importateuremploidutempsupec@marvinroger.fr &raquo;</a></p>
      <h3>L'emploi du temps n'apparaît pas sur mon portable/ordinateur ? Comment définir une notification avant chaque cours ?</h3>
      <p>
        L'emploi du temps ne s'importe pas sur votre agenda Google par défaut, mais dans un nouvel agenda nommé <i>Emploi du temps UPEC</i>. Souvent, il est nécessaire d'aller dans les paramètres de votre application agenda pour synchroniser le nouvel agenda.<br><br>
        Dans les paramètres du nouvel agenda, vous pourrez également définir qu'une notification s'affiche 30 minutes avant le début de chaque cours, par exemple.
      </p>
      <h3>Comment t'as fait ça ?</h3>
      <p>
        C'est de la programmation. Si ça vous intéresse, tout est open-source, vous pouvez jeter un coup d'oeil et éventuellement participer au code :<br>
        <ul>
          <li>API permettant d'accéder à l'emploi du temps : <a href="https://github.com/marvinroger/upec-timetable-api">https://github.com/marvinroger/upec-timetable-api</a></li>
          <li>Automatisme Google Drive et interface utilisateur : <a href="https://github.com/marvinroger/upec-timetable-importer">https://github.com/marvinroger/upec-timetable-importer</a></li>
        </ul>
      </p>
      <hr>


      <!-- Wizard start -->
      <div class="wizard" id="wizard" data-title="Installation">
        <div class="wizard-card" data-cardname="intro">
          <h3>Bienvenue</h3>
          Vous êtes sur le point d'installer l'importateur d'emploi du temps UPEC.<br>
          Assurez-vous d'avoir lu la F.A.Q. pour bien comprendre comment ça fonctionne. <a href="#" id="link_faq">Cliquez ici pour la lire.</a>
        </div>

        <div class="wizard-card" data-cardname="ids">
          <h3>IDs ADE</h3>
          Votre emploi du temps est lié à deux identifiants unique : l'un correspondant à l'année, l'autre à votre ressource. Il est nécessaire de les trouver.<br>
          Pour cela, ouvrez d'abord l'ADE (la platforme d'emploi du temps de l'UPEC). Ne faites rien d'autres, lisez la suite.<br><br>

          <p><a class="btn btn-primary btn-lg" id="button_ade" target="_blank" href="https://ade.u-pec.fr/direct/" role="button">Aller sur l'ADE</a></p><br>

          Pour trouver vos identifiants, copiez-collez le morceau de code ci-dessous dans la barre d'adresse de la page ADE. Un petit cadre apparaîtera en haut à droite.<br>
          <span class="label label-warning">Attention !</span> Parfois, en copiant-collant, le <span class="label label-default">javascript:</span> du début disparaît. Si c'est le cas, rajoutez le dans la barre d'adresse avant de valider.<br><br>

          <input class="form-control" type="text" style="cursor: text;" value="javascript:void%20function(){var%20e=document.createElement(%22script%22);e.src=%22//cdn.rawgit.com/marvinroger/upec-timetable-api/master/script/upec-ade-ids-finder.user.js%22,e.onload=e.onreadystatechange=function(){var%20e=this.readyState;e%26%26%22loaded%22!==e%26%26%22complete%22!==e||console.log(%22UPEC%20ADE%20IDs%20finder%20loaded%22)},document.getElementsByTagName(%22head%22)[0].appendChild(e)}();" readonly><br>

          Naviguez comme vous le faites habituellement jusqu'à votre emploi du temps. Renseignez ci-dessous les identifiants indiqués dans le cadre en haut à droite :<br><br>

          <div class="form-group">
            <label for="input_project_id">ID projet</label>
            <input type="number" class="form-control" id="input_project_id" placeholder="ID">
          </div>

          <div class="form-group">
            <label for="input_resource_id">ID ressource</label>
            <input type="number" class="form-control" id="input_resource_id" placeholder="ID">
          </div>
        </div>

        <div class="wizard-card" data-cardname="auth">
          <h3>Compte Google</h3>
          Pour installer l'automatisme (appelé script), nous avons besoin d'accéder au Drive de votre compte Google.<br><br>
          <p><a class="btn btn-primary btn-lg" id="button_auth" href="#" role="button">Accorder l'accès</a></p>
        </div>

        <div class="wizard-card" data-cardname="prepare">
          <h3>Préparation</h3>
          <span id="loading_prepare">Veuillez patienter...</span><br><br>

          <p><a class="btn btn-danger" id="button_delete" href="#" role="button">Supprimer l'importateur existant</a></p>

          <span id="part_agenda_id">
            Il s'agit d'une réinstallation, vous avez donc déjà reçu un mail de confirmation d'installation contenant votre identifiant agenda. Renseignez le ci-dessous. Si vous l'avez perdu, ce n'est pas grave, vous pouvez continuer. Un nouvel agenda sera alors créé.<br><br>

            <div class="form-group">
              <label for="input_agenda_id">ID agenda</label>
              <input type="text" class="form-control" id="input_agenda_id" placeholder="ID">
            </div>
          </span>
        </div>

        <div class="wizard-card" data-cardname="install1">
          <h3>Préinstallation</h3>
          <span id="loading_install1">Veuillez patienter...</span><br><br>
          <p><a class="btn btn-success" id="button_install" href="#" role="button">Préinstaller l'importateur</a></p>
        </div>

        <div class="wizard-card" data-cardname="install2">
          <h3>Installation</h3>
          L'importateur est préinstallé sur votre compte Google Drive. Il faut maintenant l'installer.
          Pour cela, cliquez sur le bouton ci-dessous, puis sur <span class="label label-default">Exécuter</span> &gt; <span class="label label-default">installer</span><br><br>

          <p><a class="btn btn-primary" id="button_doc_drive" target="_blank" href="#" role="button">Ouvrir l'importateur</a></p><br>

          Acceptez toutes les autorisations demandées, puis patientez jusqu'à ce que le cadre <span class="label label-warning">Exécution de la fonction installer...</span> disparaisse.
        </div>

        <div class="wizard-card" data-cardname="end">
          <h3>Terminé !</h3>
          Vous recevrez très rapidement un mail dans la boîte Gmail correspondant à votre compte Google. Il contient toutes les informations relative au fonctionnement de l'importateur.
        </div>
      </div>

      <footer>
        <p>&copy; Marvin Roger</p>
      </footer>
    </div>
  </body>
</html>